---
layout: post
title: Практическое применение
---

Многие читали или слышали про хорошие практики безопасности php проектов.
А что и как делать, если вам достался проект, в котором всё плохо? В этой статье я хочу поделиться своим 
опытом защиты пользователей и исправлении ситуации. 

И так нам достался купленный проект без команды, без технической базы. 
Более того это аукцион бизнесов и сайтов и значительными средствами на балансах пользователей. Имеем проблемы:
1. Заходят под логинами пользователей и выводя деньги
2. У "мертвых" пользователей восстанавливают пароли и выводят деньги
3. Подбирают пароли и добавляют на вывод свои кошельки
4. Большая часть трафика и нагрузки это боты

И так, ситуация удручающая. Но исправимая.

## Шаг №0. Локализуем проблемы, строим планы

Перед тем как кидаться в бой надо выявить технические проблемы, задокументировать и описать их.
Что имеем, что с этим не так:
* Пароли хранятся в md5
* Фреймфорк yii1 и не обновлялся никогда.
* Капчи нет
* Защиты и cdn нет
* Сканер owasp находит дырки
* Сервис на не контролированном сервере с ленивым админом в придачу
* Бекапы mysqldum табличек в отдельности
* Логи долго не хранятся
* Мониторинга нет
* Деплой из начала 2000х по ftp
* Код в git отличается от сервера

## Шаг 1: Контролируй изменения

Для любых телодвижений мы должны уметь откатываться к первоначальному состоянию. 
Поэтому, весь код должен быть под системой контроля версий. С синхронизацией кода особых проблем нету.

Налаживаем резервное копирование. Пусть это будет хоть тот же mysqldump. Пусть будут блокировки. 
Бекапы должны быть и сервис из них должен восстанавливаться.

Деплой - код должен попадать на сервер только из системы контроля версий и никак иначе. 

## Шаг 2: Контролируй управление

Вы должны позаботится о том, что бы от всех внешних сервисах был доступ. 
И не было доступа ни у кого, кроме вас. Надо найти все внешние зависимости - dns, домен, api yandex, учетки почты.
Все внешние зависимости должны быть задокументированы, пароли сброшены, телефоны и контакты должны быть указаны ваши.

Тут можно например заменить dns и уйти на cloudflare. Пока только для удобного переключения dns.

## Шаг 3: Контролируй инфраструктуру

Должен быть подготовлен новый сервер с нужным ПО, мониторингом, 
готовыми системами резервного копирования, чтобы принять сервис. Вся инфраструктура должна 
контролироваться вами.  

Сервис надо обязательно восстановить из резервной копии на новом сервере 
и протестировать основные функции.

В назначенный час X мы должны переключится на свою инфраструктуру. 
Сервис на старой инфрастуктуре должен быть отключен, но сервер работать и готовый принять обратно сервис.
В таком состоянии надо выдержать некоторое время. Например, 2 недели или больше. 
Потом выключить физически старый сервер и выждать. 


